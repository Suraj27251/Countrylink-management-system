{% extends 'layout.html' %}
{% block title %}WhatsApp Inbox{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  .wa-shell {height: calc(100vh - 120px); background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 24px rgba(15,23,42,.08); display:grid; grid-template-columns:330px 1fr;}
  .wa-page {padding-top:.35rem !important; padding-bottom:.35rem !important;}
  .wa-sidebar {background:#f8fafc; border-right:1px solid #e2e8f0; display:flex; flex-direction:column;}
  .wa-sidebar-header {padding:14px 18px; border-bottom:1px solid #e2e8f0; font-weight:700; display:flex; align-items:center; justify-content:space-between;}
  .wa-new-chat-btn {border-radius:8px;}
  .wa-search {padding:12px 16px;}
  .wa-search input {border-radius:999px;}
  .wa-list {overflow-y:auto;}
  .wa-item {display:flex; gap:10px; align-items:center; padding:12px 16px; text-decoration:none; color:inherit; border-left:3px solid transparent;}
  .wa-item:hover {background:#e2e8f0;}
  .wa-item.active {background:#dbeafe; border-left-color:#25d366;}
  .wa-avatar {width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,#25d366,#16a34a); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;}
  .wa-item-meta {min-width:0; flex:1;}
  .wa-name {font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .wa-preview {font-size:.82rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .wa-time {font-size:.72rem; color:#94a3b8;}
  .wa-main {display:flex; flex-direction:column; background:#f1f5f9; min-height:0;}
  .wa-head {background:#fff; border-bottom:1px solid #e2e8f0; padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
  .wa-head-actions {display:flex; gap:8px; align-items:center;}
  .volume {
    --line: #0f172a;
    --line-width: 5px;
    --duration: .5s;
    position: relative;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    margin: 0;
    padding: 0;
    width: 34px;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .volume input {display:none;}
  .volume svg {
    display:block;
    fill:none;
    stroke:var(--line);
    stroke-linecap:round;
    stroke-linejoin:round;
    stroke-width:var(--line-width);
    width:30px;
    height:26px;
  }
  .volume svg path {animation:var(--name) var(--duration) ease forwards;}
  .volume svg path:nth-child(2), .volume svg path:nth-child(3) {stroke-dashoffset:1px;}
  .volume input:checked + svg path:nth-child(1) {--name:shape;}
  .volume input:checked + svg path:nth-child(2) {--name:small;}
  .volume input:checked + svg path:nth-child(3) {--name:large;}
  .volume input:not(:checked) + svg path:nth-child(1) {--name:shape-r;}
  .volume input:not(:checked) + svg path:nth-child(2) {--name:small-r;}
  .volume input:not(:checked) + svg path:nth-child(3) {--name:large-r;}
  @keyframes small {
    0%, 30% {stroke-dasharray:0 0 30px 64px;}
    40% {stroke-dashoffset:16px;}
    80%, 100% {stroke-dashoffset:1px;}
    70% {stroke-dasharray:0 43px 30px 64px;}
    100% {stroke-dasharray:0 39px 30px 64px;}
  }
  @keyframes small-r {
    0% {stroke-dasharray:0 39px 30px 64px;}
    0%, 40% {stroke-dashoffset:1px;}
    70% {stroke-dashoffset:16px;}
    70%, 100% {stroke-dasharray:0 0 30px 64px;}
  }
  @keyframes large {
    0%, 30% {stroke-dasharray:0 0 50px 84px;}
    40% {stroke-dashoffset:16px;}
    80%, 100% {stroke-dashoffset:1px;}
    70% {stroke-dasharray:0 82px 32px 84px;}
    100% {stroke-dasharray:0 78px 32px 84px;}
  }
  @keyframes large-r {
    0% {stroke-dasharray:0 78px 32px 84px;}
    0%, 40% {stroke-dashoffset:1px;}
    70% {stroke-dashoffset:16px;}
    70%, 100% {stroke-dasharray:0 0 50px 84px;}
  }
  @keyframes shape {
    0% {stroke-dasharray:60px 0 184px;stroke-dashoffset:0;}
    70% {stroke-dasharray:63px 51px 184px;stroke-dashoffset:21px;}
    100% {stroke-dasharray:59px 47px 184px;stroke-dashoffset:17px;}
  }
  @keyframes shape-r {
    0% {stroke-dasharray:59px 47px 184px;stroke-dashoffset:17px;}
    100% {stroke-dasharray:60px 0 184px;stroke-dashoffset:0;}
  }
  .wa-body {flex:1; min-height:0; overflow-y:auto; padding:22px; background-image:radial-gradient(circle at 1px 1px,#e2e8f0 1px,transparent 0); background-size:20px 20px;}
  .msg-row {display:flex; margin-bottom:14px;}
  .msg-row.outbound {justify-content:flex-end;}
  .msg-bubble {max-width:75%; background:#fff; border-radius:14px; padding:10px 12px; box-shadow:0 4px 10px rgba(15,23,42,.08);}
  .msg-row.outbound .msg-bubble {background:#dcfce7;}
  .msg-text {margin:0; white-space:pre-wrap;}
  .msg-time {font-size:.7rem; color:#64748b; margin-top:4px; text-align:right;}
  .msg-status {font-size:.72rem; margin-top:4px; color:#475569; text-align:right;}
  .msg-status.failed {color:#b91c1c; font-weight:600;}
  .msg-error {font-size:.74rem; margin-top:3px; color:#b91c1c;}
  .msg-media {display:block; width:100%; max-width:420px; max-height:320px; object-fit:contain; border-radius:8px; margin-bottom:6px; background:#fff;}
  .msg-audio {max-width:320px; width:100%; margin-bottom:6px;}
  .wa-compose {background:#fff; border-top:1px solid #e2e8f0; padding:12px 16px;}
  .warn {background:#fef3c7; color:#92400e; padding:6px 10px; border-radius:8px; font-size:.82rem;}
  .modal .btn-outline-secondary {border-color:#cbd5e1;}
  @media (max-width: 992px) {.wa-shell {grid-template-columns:1fr; height:auto;} .wa-sidebar {max-height:300px;}}
</style>
{% endblock %}

{% block tabs %}
  <div class="tab"><a href="{{ url_for('dashboard') }}"><i class="fas fa-gauge"></i> Dashboard</a></div>
  <div class="tab"><a href="{{ url_for('complaints_page') }}"><i class="fas fa-code-branch"></i> Complaints</a></div>
  <div class="tab"><a href="{{ url_for('new_connections') }}"><i class="fas fa-user-plus"></i> New Connections</a></div>
  <div class="tab"><a href="{{ url_for('stock') }}"><i class="fas fa-boxes"></i> Stock</a></div>
  <div class="tab"><a href="{{ url_for('hr_dashboard') }}"><i class="fas fa-users"></i> Human Resource</a></div>
  <div class="tab active"><a href="{{ url_for('whatsapp_complaints') }}"><i class="fab fa-whatsapp"></i> WhatsApp messages</a></div>
{% endblock %}

{% block content %}
<div class="container wa-page" id="waRoot">
  <div class="wa-shell">
    <aside class="wa-sidebar">
      <div class="wa-sidebar-header">
        <span>WhatsApp Inbox</span>
        <button class="btn btn-sm btn-outline-success wa-new-chat-btn" id="newConversationBtn" title="New conversation">
          <i class="fas fa-pen-to-square"></i>
        </button>
      </div>
      <div class="wa-search"><input id="chatSearch" class="form-control form-control-sm" type="text" placeholder="Search chats"></div>
      <div class="wa-list" id="chatList">
        {% for contact in contacts %}
          <a class="wa-item {% if contact.mobile == active_mobile %}active{% endif %}" href="{{ url_for('whatsapp_complaints', mobile=contact.mobile) }}" data-mobile="{{ contact.mobile }}" data-name="{{ contact.name|lower }}">
            <div class="wa-avatar">{{ contact.name[:1]|upper }}</div>
            <div class="wa-item-meta">
              <div class="wa-name">{{ contact.name }}</div>
              <div class="wa-preview">{{ contact.preview }}</div>
            </div>
            <div class="wa-time">{{ contact.created_at.split(' ')[1][:5] if contact.created_at }}</div>
          </a>
        {% else %}
          <div class="p-4 text-center text-muted">No chats yet.</div>
        {% endfor %}
      </div>
    </aside>

    <section class="wa-main">
      <div class="wa-head">
        <div class="d-flex gap-2 align-items-center">
          <div class="wa-avatar">{{ active_name[:1]|upper if active_name else '?' }}</div>
          <div>
            <div class="fw-semibold" id="activeName">{{ active_name or 'Select a chat' }}</div>
            <div class="text-muted small" id="activeMobile">{{ active_mobile or 'No active conversation' }}</div>
          </div>
        </div>
        <div class="wa-head-actions">
          <label class="volume" id="notifyToggle" title="Notification sound: ON" aria-label="Toggle notification sound">
            <input type="checkbox" id="notifyToggleInput" checked>
            <svg viewBox="0 0 108 96">
              <path d="M7,28 L35,28 L35,28 L59,8 L59,88 L35,68 L7,68 C4.790861,68 3,66.209139 3,64 L3,32 C3,29.790861 4.790861,28 7,28 Z"></path>
              <path d="M79,62 C83,57.3333333 85,52.6666667 85,48 C85,43.3333333 83,38.6666667 79,34 L49,3"></path>
              <path d="M95,69 C101.666667,61.6666667 105,54.3333333 105,47 C105,39.6666667 101.666667,32.3333333 95,25 L75.5,6 L49,33"></path>
            </svg>
          </label>
          <button class="btn btn-sm btn-outline-success" id="templateBtn" {% if not active_mobile %}disabled{% endif %}><i class="fas fa-file-alt"></i> Template</button>
          <button class="btn btn-sm btn-outline-primary" id="interactiveBtn" {% if not active_mobile %}disabled{% endif %}><i class="fas fa-hand-pointer"></i> Interactive</button>
        </div>
      </div>

      <div class="px-3 pt-2">
        {% if not config_ready %}
          <div class="warn">Configure META_ACCESS_TOKEN, PHONE_NUMBER_ID and WABA_ID to enable WhatsApp sending.</div>
        {% endif %}
      </div>

      <div class="wa-body" id="chatBody" data-last-message-id="{{ messages[-1]['id'] if messages else 0 }}">
        {% for msg in messages %}
        <div class="msg-row {{ 'outbound' if msg['direction'] == 'outbound' else 'incoming' }}" data-message-id="{{ msg['id'] }}">
          <div class="msg-bubble">
            {% if msg['message_type'] == 'image' and msg['media_url'] %}<img class="msg-media" src="{{ url_for('static', filename=msg['media_url']) }}" alt="image">{% endif %}
            {% if msg['message_type'] == 'video' and msg['media_url'] %}<video class="msg-media" controls src="{{ url_for('static', filename=msg['media_url']) }}"></video>{% endif %}
            {% if msg['message_type'] == 'audio' and msg['media_url'] %}<audio class="msg-audio" controls src="{{ url_for('static', filename=msg['media_url']) }}"></audio>{% endif %}
            {% if msg['message_type'] == 'document' and msg['media_url'] %}
              <a class="btn btn-sm btn-light" href="{{ url_for('static', filename=msg['media_url']) }}" target="_blank"><i class="fas fa-file"></i> {{ msg['file_name'] or 'Document' }}</a>
            {% endif %}
            <p class="msg-text">{{ msg['text'] or ('Template message' if msg['message_type'] == 'template' else 'Interactive message') }}</p>
            {% if msg['error_reason'] %}<div class="msg-error">{{ msg['error_reason'] }}</div>{% endif %}
            {% if msg['delivery_status'] %}<div class="msg-status {{ 'failed' if msg['delivery_status'] == 'failed' else '' }}">{{ msg['delivery_status']|upper }}</div>{% endif %}
            <div class="msg-time">{{ msg['created_at'].split(' ')[1][:5] if msg['created_at'] else '' }}</div>
          </div>
        </div>
        {% else %}
          <div class="text-center text-muted mt-5" id="emptyConversationHint">No messages in this conversation yet.</div>
        {% endfor %}
      </div>

      <div class="wa-compose">
        <form id="chatForm" class="row g-2 align-items-center">
          <input type="hidden" name="mobile" value="{{ active_mobile or '' }}">
          <div class="col-12 col-md-auto"><input type="file" class="form-control form-control-sm" name="attachment" id="attachment"></div>
          <div class="col-12 col-md"><input class="form-control" type="text" name="message" placeholder="Type a message" {% if not active_mobile %}disabled{% endif %}></div>
          <div class="col-auto"><button class="btn btn-success" {% if not active_mobile or not config_ready %}disabled{% endif %}>Send</button></div>
        </form>
      </div>
    </section>
  </div>
</div>

<div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Send template message</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-3"><label class="form-label">Template</label><select id="templateSelect" class="form-select"></select></div>
      <div class="mb-3"><label class="form-label">Language</label><input id="templateLanguage" class="form-control" value="en_US"></div>
      <div id="templateParams" class="row g-2"></div>
      <div class="small text-muted mt-2">Supports body placeholders like <code>{% raw %}{{1}}{% endraw %}</code>, <code>{% raw %}{{2}}{% endraw %}</code> and named placeholders from template components.</div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-success" id="sendTemplateConfirm">Send template</button></div>
  </div></div>
</div>

<div class="modal fade" id="newConversationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">New conversation</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="small text-muted mb-3">Start a conversation by sending a WhatsApp template message.</div>
      <div class="mb-3"><label class="form-label">Recipient phone number</label><input id="newConvMobile" class="form-control" placeholder="+1234567890"></div>
      <div class="mb-3"><label class="form-label">Template</label><select id="newConvTemplateSelect" class="form-select"></select></div>
      <div class="mb-3"><label class="form-label">Language</label><input id="newConvTemplateLanguage" class="form-control" value="en_US"></div>
      <div id="newConvTemplateParams" class="row g-2"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-success" id="startConversationConfirm"><i class="fas fa-paper-plane"></i> Start conversation</button></div>
  </div></div>
</div>

<div class="modal fade" id="interactiveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Send interactive message</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <ul class="nav nav-pills nav-fill mb-3" id="interactiveTypeTabs">
        <li class="nav-item"><button class="nav-link active" type="button" data-type="button">Buttons</button></li>
        <li class="nav-item"><button class="nav-link" type="button" data-type="list">List</button></li>
        <li class="nav-item"><button class="nav-link" type="button" data-type="cta_url">CTA URL</button></li>
        <li class="nav-item"><button class="nav-link" type="button" data-type="flow">Flow</button></li>
      </ul>
      <div class="mb-2"><label class="form-label">Header (optional)</label><input id="interactiveHeader" class="form-control" maxlength="60"></div>
      <div class="mb-2"><label class="form-label">Body</label><textarea id="interactiveBody" class="form-control" rows="3" maxlength="1024"></textarea></div>
      <div class="mb-2"><label class="form-label">Footer (optional)</label><input id="interactiveFooter" class="form-control" maxlength="60"></div>

      <div id="interactiveButtonsPane" class="interactive-pane">
        <div id="interactiveButtons"></div>
        <button class="btn btn-sm btn-outline-secondary mt-2" id="addBtnRow" type="button">+ Add button</button>
        <div class="small text-muted mt-2">1-3 buttons, each title max 20 chars.</div>
      </div>

      <div id="interactiveListPane" class="interactive-pane d-none">
        <div class="mb-2"><label class="form-label">List button text</label><input id="listButtonText" class="form-control" maxlength="20" placeholder="View options"></div>
        <div id="listSectionsWrap"></div>
        <button class="btn btn-sm btn-outline-secondary mt-2" id="addSectionBtn" type="button">+ Add section</button>
        <div class="small text-muted mt-2">Max 10 rows across all sections.</div>
      </div>

      <div id="interactiveCtaPane" class="interactive-pane d-none">
        <div class="mb-2"><label class="form-label">Button text</label><input id="ctaButtonText" class="form-control" maxlength="20" placeholder="Visit website"></div>
        <div class="mb-2"><label class="form-label">Button URL</label><input id="ctaButtonUrl" class="form-control" placeholder="https://example.com"></div>
      </div>

      <div id="interactiveFlowPane" class="interactive-pane d-none">
        <div class="mb-2"><label class="form-label">Flow ID</label><input id="flowId" class="form-control" placeholder="Enter flow id"></div>
        <div class="mb-2"><label class="form-label">Button text</label><input id="flowButtonText" class="form-control" maxlength="20" value="Open"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" id="sendInteractiveConfirm">Send interactive</button></div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  const activeMobile = '{{ active_mobile or "" }}';
  const apiUrl = '{{ url_for("whatsapp_messages_api") }}';
  const pageUrl = '{{ url_for("whatsapp_complaints") }}';
  const sendUrl = '{{ url_for("send_whatsapp") }}';
  const templateListUrl = '{{ url_for("whatsapp_templates_api") }}';
  const sendTemplateUrl = '{{ url_for("send_whatsapp_template_api") }}';
  const sendInteractiveUrl = '{{ url_for("send_whatsapp_interactive_api") }}';
  const staticBase = '{{ url_for("static", filename="") }}';

  const chatBody = document.getElementById('chatBody');
  const chatList = document.getElementById('chatList');
  const chatForm = document.getElementById('chatForm');
  const emptyConversationHint = document.getElementById('emptyConversationHint');
  const search = document.getElementById('chatSearch');
  const activeNameEl = document.getElementById('activeName');
  const activeMobileEl = document.getElementById('activeMobile');
  const notifyToggle = document.getElementById('notifyToggle');
  const notifyToggleInput = document.getElementById('notifyToggleInput');
  const newConversationBtn = document.getElementById('newConversationBtn');
  const templateBtn = document.getElementById('templateBtn');
  const interactiveBtn = document.getElementById('interactiveBtn');
  let lastMessageId = Number(chatBody?.dataset.lastMessageId || 0);
  let lastInboxMessageId = lastMessageId;
  let templates = [];
  const notificationStorageKey = 'wa_sound_notifications_enabled';
  const initialPref = localStorage.getItem(notificationStorageKey);
  let notificationsEnabled = initialPref === null ? true : initialPref === '1';
  const knownMessageIds = new Set([...document.querySelectorAll('#chatBody [data-message-id]')].map((el) => el.dataset.messageId));
  knownMessageIds.forEach((id) => {
    const asNumber = Number(id);
    if (!Number.isNaN(asNumber)) {
      lastInboxMessageId = Math.max(lastInboxMessageId, asNumber);
    }
  });
  let hasUserInteracted = false;
  const notificationSound = new Audio();
  notificationSound.preload = 'none';

  const markUserInteraction = () => {
    hasUserInteracted = true;
  };
  window.addEventListener('pointerdown', markUserInteraction, { once: true });
  window.addEventListener('keydown', markUserInteraction, { once: true });

  const fallbackBeep = () => {
    if (!hasUserInteracted) return;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    const ctx = new AudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 880;
    gain.gain.value = 0.001;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.22);
    osc.stop(ctx.currentTime + 0.24);
  };

  const playNotificationSound = () => {
    if (!notificationsEnabled || !hasUserInteracted) return;
    if (!notificationSound.src) {
      notificationSound.src = `${staticBase}audio/whatsapp_notification.wav`;
    }
    notificationSound.currentTime = 0;
    notificationSound.play().catch(() => {
      fallbackBeep();
    });
  };

  const isInboundMessage = (message) => {
    if (typeof message?.from_me === 'boolean') {
      return !message.from_me;
    }
    return message?.direction !== 'outbound';
  };

  const setNotifyUi = () => {
    if (!notifyToggle || !notifyToggleInput) return;
    // For this SVG animation, checked state visually represents muted.
    notifyToggleInput.checked = !notificationsEnabled;
    notifyToggle.title = notificationsEnabled ? 'Notification sound: ON' : 'Notification sound: OFF';
  };
  setNotifyUi();
  notifyToggleInput?.addEventListener('change', () => {
    notificationsEnabled = !notifyToggleInput.checked;
    localStorage.setItem(notificationStorageKey, notificationsEnabled ? '1' : '0');
    setNotifyUi();
  });

  const esc = (v) => String(v || '').replace(/[&<>'"]/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[m]));
  const fmt = (ts) => (ts && ts.includes(' ')) ? ts.split(' ')[1].slice(0,5) : '';
  const autoscroll = () => chatBody && (chatBody.scrollHeight - chatBody.scrollTop - chatBody.clientHeight < 120);
  const scrollBottom = () => { if (chatBody) chatBody.scrollTop = chatBody.scrollHeight; };

  const renderMessage = (m) => {
    const row = document.createElement('div');
    row.className = `msg-row ${m.direction === 'outbound' ? 'outbound' : 'incoming'}`;
    row.dataset.messageId = m.id;
    const media = m.media_url ? `${staticBase}${m.media_url}` : '';
    let html = '';
    if (m.message_type === 'image') html += media ? `<img class="msg-media" src="${media}" alt="image">` : '';
    if (m.message_type === 'video') html += media ? `<video class="msg-media" controls src="${media}"></video>` : '';
    if (m.message_type === 'audio') html += media ? `<audio class="msg-audio" controls src="${media}"></audio>` : '';
    if (m.message_type === 'document') html += media ? `<a target="_blank" class="btn btn-sm btn-light" href="${media}"><i class="fas fa-file"></i> ${esc(m.file_name || 'Document')}</a>` : '';
    const text = esc(m.text || (m.message_type === 'template' ? 'Template message' : m.message_type === 'interactive' ? 'Interactive message' : ''));
    const status = esc((m.delivery_status || '').toUpperCase());
    const statusClass = (m.delivery_status || '').toLowerCase() === 'failed' ? 'failed' : '';
    const errorText = m.error_reason ? `<div class="msg-error">${esc(m.error_reason)}</div>` : '';
    const statusHtml = status ? `<div class="msg-status ${statusClass}">${status}</div>` : '';
    html += `<p class="msg-text">${text}</p>${errorText}${statusHtml}<div class="msg-time">${fmt(m.created_at)}</div>`;
    row.innerHTML = `<div class="msg-bubble">${html}</div>`;
    return row;
  };

  const upsertMessage = (m) => {
    const existing = chatBody?.querySelector(`[data-message-id="${m.id}"]`);
    const freshRow = renderMessage(m);
    if (!existing) {
      emptyConversationHint?.remove();
      chatBody.appendChild(freshRow);
      const msgId = String(m.id || '');
      const isNew = msgId && !knownMessageIds.has(msgId);
      knownMessageIds.add(msgId);
      if (isNew) {
        lastInboxMessageId = Math.max(lastInboxMessageId, Number(m.id) || 0);
      }
      return;
    }
    existing.className = freshRow.className;
    existing.innerHTML = freshRow.innerHTML;
  };

  const renderContacts = (contacts) => {
    chatList.innerHTML = contacts.length ? contacts.map(c => `
      <a class="wa-item ${c.mobile === activeMobile ? 'active' : ''}" href="${pageUrl}?mobile=${encodeURIComponent(c.mobile)}" data-mobile="${esc(c.mobile)}" data-name="${esc((c.name || '').toLowerCase())}">
        <div class="wa-avatar">${esc((c.name || c.mobile || '?').slice(0,1).toUpperCase())}</div>
        <div class="wa-item-meta"><div class="wa-name">${esc(c.name || c.mobile)}</div><div class="wa-preview">${esc(c.preview || '')}</div></div>
        <div class="wa-time">${fmt(c.created_at)}</div>
      </a>`).join('') : '<div class="p-4 text-center text-muted">No chats yet.</div>';
  };

  async function poll() {
    const q = new URLSearchParams({include_contacts: '1'});
    q.set('since_inbox_id', String(lastInboxMessageId || 0));
    if (activeMobile) {
      q.set('mobile', activeMobile);
      q.set('since_id', String(lastMessageId || 0));
    }
    const res = await fetch(`${apiUrl}?${q.toString()}`, {headers: {'X-Requested-With':'XMLHttpRequest'}});
    if (!res.ok) return;
    const data = await res.json();
    if (data.contacts) renderContacts(data.contacts);
    if (data.inbox_messages?.length) {
      data.inbox_messages.forEach((m) => {
        const msgId = String(m.id || '');
        if (!msgId || knownMessageIds.has(msgId)) return;
        knownMessageIds.add(msgId);
        lastInboxMessageId = Math.max(lastInboxMessageId, Number(m.id) || 0);
        if (isInboundMessage(m)) {
          playNotificationSound();
        }
      });
    }
    if (data.last_inbox_message_id) {
      lastInboxMessageId = Math.max(lastInboxMessageId, Number(data.last_inbox_message_id) || 0);
    }
    if (data.active_name) activeNameEl.textContent = data.active_name;
    if (data.active_mobile) activeMobileEl.textContent = data.active_mobile;
    if (data.messages?.length) {
      const auto = autoscroll();
      data.messages.forEach((m) => {
        upsertMessage(m);
      });
      lastMessageId = data.last_message_id || lastMessageId;
      if (auto) scrollBottom();
    }
  }

  chatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(chatForm);
    const r = await fetch(sendUrl, {method:'POST', body:fd});
    if (!r.ok) { const p = await r.json(); alert(p.error || 'Failed to send message'); return; }
    chatForm.reset();
    await poll();
  });

  search?.addEventListener('input', () => {
    const q = search.value.trim().toLowerCase();
    chatList.querySelectorAll('.wa-item').forEach((item) => {
      const txt = `${item.dataset.name || ''} ${item.dataset.mobile || ''}`;
      item.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
  const interactiveModal = new bootstrap.Modal(document.getElementById('interactiveModal'));
  const newConversationModal = new bootstrap.Modal(document.getElementById('newConversationModal'));

  function extractPlaceholderVars(text) {
    if (!text) return [];
    const seen = new Set();
    const regex = /\{\{\s*([^}]+?)\s*\}\}/g;
    return [...String(text).matchAll(regex)]
      .map((m) => m[1].trim())
      .filter((v) => (v && !seen.has(v) ? (seen.add(v), true) : false));
  }

  function getTemplateBodyVars(template) {
    const components = template?.components || [];
    const bodyComp = components.find((c) => String(c?.type || '').toUpperCase() === 'BODY');
    const candidateTexts = [
      bodyComp?.text,
      bodyComp?.body_text,
      ...(Array.isArray(bodyComp?.example?.body_text) ? bodyComp.example.body_text : []),
      ...(Array.isArray(template?.example?.body_text) ? template.example.body_text : []),
    ].filter(Boolean);
    const merged = [];
    candidateTexts.forEach((txt) => merged.push(...extractPlaceholderVars(txt)));
    return [...new Set(merged)];
  }

  function getTemplateBodyText(template) {
    const components = template?.components || [];
    const bodyComp = components.find((c) => String(c?.type || '').toUpperCase() === 'BODY');
    return bodyComp?.text || bodyComp?.body_text || '';
  }

  function buildTemplatePreview(template, values) {
    const bodyText = getTemplateBodyText(template);
    if (!bodyText) return `Template: ${template?.name || ''}`.trim();
    let rendered = String(bodyText);
    values.forEach((value, idx) => {
      const slotIndex = idx + 1;
      rendered = rendered.replace(new RegExp(`\\\\{\\\\{\\\\s*${slotIndex}\\\\s*\\\\}\\\\}`, 'g'), value);
    });
    return rendered;
  }

  const normalizePhone = (value) => String(value || '').replace(/[^\d]/g, '');

  function renderTemplateOptions(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    select.innerHTML = templates.map((t) => `<option value="${esc(t.name)}">${esc(t.name)} (${esc(t.language || 'en_US')})</option>`).join('') || '<option value="">No approved templates</option>';
  }

  function fillTemplateParamForm({ templateSelectId, languageInputId, paramsWrapId }) {
    const templateSelect = document.getElementById(templateSelectId);
    const t = templates.find((x) => x.name === templateSelect.value);
    const params = getTemplateBodyVars(t || {});
    const wrap = document.getElementById(paramsWrapId);
    wrap.innerHTML = params.length
      ? params.map((p, i) => `<div class="col-md-6"><label class="form-label">Param ${i+1} (${esc(p)})</label><input class="form-control" data-param="${esc(p)}"></div>`).join('')
      : '<div class="text-muted small">No body parameters detected.</div>';
    document.getElementById(languageInputId).value = t?.language || 'en_US';
  }

  async function loadTemplates() {
    if (templates.length) return;
    const res = await fetch(templateListUrl);
    if (!res.ok) return;
    const payload = await res.json();
    templates = (payload.data || []).filter((t) => (t.status || '').toUpperCase() === 'APPROVED');
    renderTemplateOptions('templateSelect');
    renderTemplateOptions('newConvTemplateSelect');
    document.getElementById('templateSelect').dispatchEvent(new Event('change'));
    document.getElementById('newConvTemplateSelect').dispatchEvent(new Event('change'));
  }

  document.getElementById('templateSelect').addEventListener('change', (e) => {
    fillTemplateParamForm({
      templateSelectId: 'templateSelect',
      languageInputId: 'templateLanguage',
      paramsWrapId: 'templateParams',
    });
  });

  document.getElementById('newConvTemplateSelect').addEventListener('change', () => {
    fillTemplateParamForm({
      templateSelectId: 'newConvTemplateSelect',
      languageInputId: 'newConvTemplateLanguage',
      paramsWrapId: 'newConvTemplateParams',
    });
  });

  templateBtn?.addEventListener('click', async () => { await loadTemplates(); templateModal.show(); });
  newConversationBtn?.addEventListener('click', async () => {
    await loadTemplates();
    document.getElementById('newConvMobile').value = '';
    newConversationModal.show();
  });

  document.getElementById('sendTemplateConfirm').addEventListener('click', async () => {
    const tName = document.getElementById('templateSelect').value;
    if (!tName) return;
    const language = document.getElementById('templateLanguage').value || 'en_US';
    const inputs = [...document.querySelectorAll('#templateParams [data-param]')];
    const values = inputs.map((input) => (input.value || '').trim());
    if (values.some((v) => !v)) {
      alert('Please fill all required template parameters.');
      return;
    }
    const bodyParams = values.map((value) => ({type:'text', text: value}));
    const t = templates.find((x) => x.name === tName);
    const payload = {
      mobile: activeMobile,
      template_name: tName,
      language_code: language,
      template_preview: buildTemplatePreview(t || {}, values),
      components: bodyParams.length ? [{type:'body', parameters: bodyParams}] : []
    };
    const res = await fetch(sendTemplateUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Failed to send template'); return; }
    templateModal.hide();
    await poll();
  });

  document.getElementById('startConversationConfirm').addEventListener('click', async () => {
    const mobile = normalizePhone(document.getElementById('newConvMobile').value);
    const tName = document.getElementById('newConvTemplateSelect').value;
    if (!mobile) {
      alert('Recipient phone number is required.');
      return;
    }
    if (!tName) {
      alert('Template is required.');
      return;
    }
    const language = document.getElementById('newConvTemplateLanguage').value || 'en_US';
    const inputs = [...document.querySelectorAll('#newConvTemplateParams [data-param]')];
    const values = inputs.map((input) => (input.value || '').trim());
    if (values.some((v) => !v)) {
      alert('Please fill all required template parameters.');
      return;
    }
    const t = templates.find((x) => x.name === tName);
    const payload = {
      mobile,
      template_name: tName,
      language_code: language,
      template_preview: buildTemplatePreview(t || {}, values),
      components: values.length ? [{type:'body', parameters: values.map((value) => ({type:'text', text: value}))}] : []
    };
    const res = await fetch(sendTemplateUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if (!res.ok) {
      if (data?.stored) {
        alert((data.error || 'Template send failed') + '. Opening conversation for status tracking.');
        newConversationModal.hide();
        window.location.href = `${pageUrl}?mobile=${encodeURIComponent(data.mobile || mobile)}`;
        return;
      }
      alert(data.error || 'Failed to start conversation');
      return;
    }
    newConversationModal.hide();
    window.location.href = `${pageUrl}?mobile=${encodeURIComponent(mobile)}`;
  });

  const buttonsWrap = document.getElementById('interactiveButtons');
  const listSectionsWrap = document.getElementById('listSectionsWrap');
  let interactiveType = 'button';

  const reindexButtonRows = () => {
    [...buttonsWrap.querySelectorAll('.btn-row')].forEach((row, idx) => {
      row.querySelector('.input-group-text').textContent = String(idx + 1);
    });
  };

  const addButtonRow = (title = '') => {
    if (buttonsWrap.querySelectorAll('.btn-row').length >= 3) return;
    const row = document.createElement('div');
    row.className = 'input-group mb-2 btn-row';
    row.innerHTML = `<span class="input-group-text"></span><input class="form-control btn-title" maxlength="20" placeholder="Button title" value="${esc(title)}"><button class="btn btn-outline-danger" type="button">Ã—</button>`;
    row.querySelector('button').addEventListener('click', () => { row.remove(); reindexButtonRows(); });
    buttonsWrap.appendChild(row);
    reindexButtonRows();
  };

  const getTotalListRows = () => document.querySelectorAll('.list-row').length;
  const addListRow = (rowsWrap, title = '', description = '') => {
    if (getTotalListRows() >= 10) return;
    const row = document.createElement('div');
    row.className = 'border rounded p-2 mb-2 list-row';
    row.innerHTML = `
      <input class="form-control form-control-sm mb-2 list-row-title" maxlength="24" placeholder="Row title" value="${esc(title)}">
      <input class="form-control form-control-sm list-row-description" maxlength="72" placeholder="Description (optional)" value="${esc(description)}">
      <button class="btn btn-sm btn-outline-danger mt-2" type="button">Remove row</button>
    `;
    row.querySelector('button').addEventListener('click', () => row.remove());
    rowsWrap.appendChild(row);
  };

  const addSection = (title = 'Options') => {
    const card = document.createElement('div');
    card.className = 'border rounded p-2 mb-2 list-section';
    card.innerHTML = `
      <div class="d-flex gap-2 mb-2">
        <input class="form-control form-control-sm list-section-title" maxlength="24" placeholder="Section title" value="${esc(title)}">
        <button class="btn btn-sm btn-outline-danger" type="button">Remove section</button>
      </div>
      <div class="list-rows-wrap"></div>
      <button class="btn btn-sm btn-outline-secondary mt-2" type="button">+ Add row</button>
    `;
    const removeBtn = card.querySelector('.btn-outline-danger');
    const addRowBtn = card.querySelector('.btn-outline-secondary');
    const rowsWrap = card.querySelector('.list-rows-wrap');
    removeBtn.addEventListener('click', () => card.remove());
    addRowBtn.addEventListener('click', () => addListRow(rowsWrap));
    listSectionsWrap.appendChild(card);
    addListRow(rowsWrap, 'Option 1', '');
  };

  const setInteractiveType = (type) => {
    interactiveType = type;
    document.querySelectorAll('#interactiveTypeTabs .nav-link').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.type === type);
    });
    document.querySelectorAll('.interactive-pane').forEach((pane) => pane.classList.add('d-none'));
    if (type === 'button') document.getElementById('interactiveButtonsPane').classList.remove('d-none');
    if (type === 'list') document.getElementById('interactiveListPane').classList.remove('d-none');
    if (type === 'cta_url') document.getElementById('interactiveCtaPane').classList.remove('d-none');
    if (type === 'flow') document.getElementById('interactiveFlowPane').classList.remove('d-none');
  };

  const resetInteractiveForm = () => {
    document.getElementById('interactiveHeader').value = '';
    document.getElementById('interactiveBody').value = '';
    document.getElementById('interactiveFooter').value = '';
    buttonsWrap.innerHTML = '';
    addButtonRow('Yes');
    addButtonRow('No');

    document.getElementById('listButtonText').value = 'View options';
    listSectionsWrap.innerHTML = '';
    addSection('Options');

    document.getElementById('ctaButtonText').value = 'Visit website';
    document.getElementById('ctaButtonUrl').value = '';
    document.getElementById('flowId').value = '';
    document.getElementById('flowButtonText').value = 'Open';
    setInteractiveType('button');
  };

  document.getElementById('addBtnRow').addEventListener('click', () => addButtonRow());
  document.getElementById('addSectionBtn').addEventListener('click', () => addSection('Section'));
  document.querySelectorAll('#interactiveTypeTabs .nav-link').forEach((tabBtn) => {
    tabBtn.addEventListener('click', () => setInteractiveType(tabBtn.dataset.type));
  });

  interactiveBtn?.addEventListener('click', () => {
    resetInteractiveForm();
    interactiveModal.show();
  });

  document.getElementById('sendInteractiveConfirm').addEventListener('click', async () => {
    const body = document.getElementById('interactiveBody').value.trim();
    const header = document.getElementById('interactiveHeader').value.trim();
    const footer = document.getElementById('interactiveFooter').value.trim();
    if (!body) { alert('Body is required.'); return; }

    const payload = { mobile: activeMobile, interactive_type: interactiveType, header, body, footer };

    if (interactiveType === 'button') {
      const titles = [...document.querySelectorAll('.btn-title')].map((el) => el.value.trim()).filter(Boolean).slice(0, 3);
      if (titles.length < 1) { alert('Add at least one button title.'); return; }
      payload.buttons = titles.map((title, i) => ({id: `btn_${Date.now()}_${i + 1}`, title}));
    } else if (interactiveType === 'list') {
      const listButtonText = document.getElementById('listButtonText').value.trim();
      const sections = [...document.querySelectorAll('.list-section')].map((section, sectionIdx) => {
        const rows = [...section.querySelectorAll('.list-row')].map((row, rowIdx) => ({
          id: `sec_${sectionIdx + 1}_row_${rowIdx + 1}_${Date.now()}`,
          title: row.querySelector('.list-row-title').value.trim(),
          description: row.querySelector('.list-row-description').value.trim(),
        })).filter((row) => row.title);
        return {
          title: section.querySelector('.list-section-title').value.trim(),
          rows,
        };
      }).filter((section) => section.rows.length);
      const totalRows = sections.reduce((sum, section) => sum + section.rows.length, 0);
      if (!listButtonText || !sections.length || totalRows < 1) { alert('List button text and at least one row are required.'); return; }
      if (totalRows > 10) { alert('Total list rows cannot exceed 10.'); return; }
      payload.list_button_text = listButtonText;
      payload.sections = sections;
    } else if (interactiveType === 'cta_url') {
      const buttonText = document.getElementById('ctaButtonText').value.trim();
      const buttonUrl = document.getElementById('ctaButtonUrl').value.trim();
      if (!buttonText || !buttonUrl) { alert('Button text and URL are required for CTA URL.'); return; }
      payload.button_text = buttonText;
      payload.button_url = buttonUrl;
    } else if (interactiveType === 'flow') {
      const flowId = document.getElementById('flowId').value.trim();
      const buttonText = document.getElementById('flowButtonText').value.trim();
      if (!flowId || !buttonText) { alert('Flow ID and button text are required for Flow.'); return; }
      payload.flow_id = flowId;
      payload.button_text = buttonText;
    }

    const res = await fetch(sendInteractiveUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Failed to send interactive message'); return; }
    interactiveModal.hide();
    await poll();
  });

  scrollBottom();
  setInterval(() => poll().catch(() => {}), 5000);
})();
</script>
{% endblock %}
