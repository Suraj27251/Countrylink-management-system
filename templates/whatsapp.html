{% extends 'layout.html' %}
{% block title %}WhatsApp Inbox{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  .wa-shell {height: calc(100vh - 140px); background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 24px rgba(15,23,42,.08); display:grid; grid-template-columns:330px 1fr;}
  .wa-sidebar {background:#f8fafc; border-right:1px solid #e2e8f0; display:flex; flex-direction:column;}
  .wa-sidebar-header {padding:14px 18px; border-bottom:1px solid #e2e8f0; font-weight:700; display:flex; align-items:center; justify-content:space-between;}
  .wa-search {padding:12px 16px;}
  .wa-search input {border-radius:999px;}
  .wa-list {overflow-y:auto;}
  .wa-item {display:flex; gap:10px; align-items:center; padding:12px 16px; text-decoration:none; color:inherit; border-left:3px solid transparent;}
  .wa-item:hover {background:#e2e8f0;}
  .wa-item.active {background:#dbeafe; border-left-color:#25d366;}
  .wa-avatar {width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,#25d366,#16a34a); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;}
  .wa-item-meta {min-width:0; flex:1;}
  .wa-name {font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .wa-preview {font-size:.82rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .wa-time {font-size:.72rem; color:#94a3b8;}
  .wa-main {display:flex; flex-direction:column; background:#f1f5f9;}
  .wa-head {background:#fff; border-bottom:1px solid #e2e8f0; padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
  .wa-head-actions {display:flex; gap:8px;}
  .wa-body {flex:1; overflow-y:auto; padding:22px; background-image:radial-gradient(circle at 1px 1px,#e2e8f0 1px,transparent 0); background-size:20px 20px;}
  .msg-row {display:flex; margin-bottom:14px;}
  .msg-row.outbound {justify-content:flex-end;}
  .msg-bubble {max-width:75%; background:#fff; border-radius:14px; padding:10px 12px; box-shadow:0 4px 10px rgba(15,23,42,.08);}
  .msg-row.outbound .msg-bubble {background:#dcfce7;}
  .msg-text {margin:0; white-space:pre-wrap;}
  .msg-time {font-size:.7rem; color:#64748b; margin-top:4px; text-align:right;}
  .msg-media {max-width:100%; border-radius:8px; margin-bottom:6px;}
  .wa-compose {background:#fff; border-top:1px solid #e2e8f0; padding:12px 16px;}
  .warn {background:#fef3c7; color:#92400e; padding:6px 10px; border-radius:8px; font-size:.82rem;}
  .modal .btn-outline-secondary {border-color:#cbd5e1;}
  @media (max-width: 992px) {.wa-shell {grid-template-columns:1fr; height:auto;} .wa-sidebar {max-height:300px;}}
</style>
{% endblock %}

{% block tabs %}
  <div class="tab"><a href="{{ url_for('dashboard') }}"><i class="fas fa-gauge"></i> Dashboard</a></div>
  <div class="tab"><a href="{{ url_for('complaints_page') }}"><i class="fas fa-code-branch"></i> Complaints</a></div>
  <div class="tab"><a href="{{ url_for('new_connections') }}"><i class="fas fa-user-plus"></i> New Connections</a></div>
  <div class="tab"><a href="{{ url_for('stock') }}"><i class="fas fa-boxes"></i> Stock</a></div>
  <div class="tab"><a href="{{ url_for('hr_dashboard') }}"><i class="fas fa-users"></i> Human Resource</a></div>
  <div class="tab active"><a href="{{ url_for('whatsapp_complaints') }}"><i class="fab fa-whatsapp"></i> WhatsApp messages</a></div>
{% endblock %}

{% block content %}
<div class="container py-4" id="waRoot">
  <div class="wa-shell">
    <aside class="wa-sidebar">
      <div class="wa-sidebar-header">WhatsApp Inbox <i class="fab fa-whatsapp text-success"></i></div>
      <div class="wa-search"><input id="chatSearch" class="form-control form-control-sm" type="text" placeholder="Search chats"></div>
      <div class="wa-list" id="chatList">
        {% for contact in contacts %}
          <a class="wa-item {% if contact.mobile == active_mobile %}active{% endif %}" href="{{ url_for('whatsapp_complaints', mobile=contact.mobile) }}" data-mobile="{{ contact.mobile }}" data-name="{{ contact.name|lower }}">
            <div class="wa-avatar">{{ contact.name[:1]|upper }}</div>
            <div class="wa-item-meta">
              <div class="wa-name">{{ contact.name }}</div>
              <div class="wa-preview">{{ contact.preview }}</div>
            </div>
            <div class="wa-time">{{ contact.created_at.split(' ')[1][:5] if contact.created_at }}</div>
          </a>
        {% else %}
          <div class="p-4 text-center text-muted">No chats yet.</div>
        {% endfor %}
      </div>
    </aside>

    <section class="wa-main">
      <div class="wa-head">
        <div class="d-flex gap-2 align-items-center">
          <div class="wa-avatar">{{ active_name[:1]|upper if active_name else '?' }}</div>
          <div>
            <div class="fw-semibold" id="activeName">{{ active_name or 'Select a chat' }}</div>
            <div class="text-muted small" id="activeMobile">{{ active_mobile or 'No active conversation' }}</div>
          </div>
        </div>
        <div class="wa-head-actions">
          <button class="btn btn-sm btn-outline-success" id="templateBtn" {% if not active_mobile %}disabled{% endif %}><i class="fas fa-file-alt"></i> Template</button>
          <button class="btn btn-sm btn-outline-primary" id="interactiveBtn" {% if not active_mobile %}disabled{% endif %}><i class="fas fa-hand-pointer"></i> Interactive</button>
        </div>
      </div>

      <div class="px-3 pt-2">
        {% if not config_ready %}
          <div class="warn">Configure META_ACCESS_TOKEN, PHONE_NUMBER_ID and WABA_ID to enable WhatsApp sending.</div>
        {% endif %}
      </div>

      <div class="wa-body" id="chatBody" data-last-message-id="{{ messages[-1]['id'] if messages else 0 }}">
        {% for msg in messages %}
        <div class="msg-row {{ 'outbound' if msg['direction'] == 'outbound' else 'incoming' }}" data-message-id="{{ msg['id'] }}">
          <div class="msg-bubble">
            {% if msg['message_type'] == 'image' and msg['media_url'] %}<img class="msg-media" src="{{ url_for('static', filename=msg['media_url']) }}" alt="image">{% endif %}
            {% if msg['message_type'] == 'video' and msg['media_url'] %}<video class="msg-media" controls src="{{ url_for('static', filename=msg['media_url']) }}"></video>{% endif %}
            {% if msg['message_type'] == 'audio' and msg['media_url'] %}<audio controls src="{{ url_for('static', filename=msg['media_url']) }}"></audio>{% endif %}
            {% if msg['message_type'] == 'document' and msg['media_url'] %}
              <a class="btn btn-sm btn-light" href="{{ url_for('static', filename=msg['media_url']) }}" target="_blank"><i class="fas fa-file"></i> {{ msg['file_name'] or 'Document' }}</a>
            {% endif %}
            <p class="msg-text">{{ msg['text'] or ('Template message' if msg['message_type'] == 'template' else 'Interactive message') }}</p>
            <div class="msg-time">{{ msg['created_at'].split(' ')[1][:5] if msg['created_at'] else '' }}</div>
          </div>
        </div>
        {% else %}
          <div class="text-center text-muted mt-5">No messages in this conversation yet.</div>
        {% endfor %}
      </div>

      <div class="wa-compose">
        <form id="chatForm" class="row g-2 align-items-center">
          <input type="hidden" name="mobile" value="{{ active_mobile or '' }}">
          <div class="col-auto"><input type="file" class="form-control form-control-sm" name="attachment" id="attachment"></div>
          <div class="col"><input class="form-control" type="text" name="message" placeholder="Type a message" {% if not active_mobile %}disabled{% endif %}></div>
          <div class="col-auto"><button class="btn btn-success" {% if not active_mobile or not config_ready %}disabled{% endif %}>Send</button></div>
        </form>
      </div>
    </section>
  </div>
</div>

<div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Send template message</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-3"><label class="form-label">Template</label><select id="templateSelect" class="form-select"></select></div>
      <div class="mb-3"><label class="form-label">Language</label><input id="templateLanguage" class="form-control" value="en_US"></div>
      <div id="templateParams" class="row g-2"></div>
      <div class="small text-muted mt-2">Supports body placeholders like <code>{% raw %}{{1}}{% endraw %}</code>, <code>{% raw %}{{2}}{% endraw %}</code> and named placeholders from template components.</div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-success" id="sendTemplateConfirm">Send template</button></div>
  </div></div>
</div>

<div class="modal fade" id="interactiveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Send interactive buttons</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-2"><label class="form-label">Header (optional)</label><input id="interactiveHeader" class="form-control" maxlength="60"></div>
      <div class="mb-2"><label class="form-label">Body</label><textarea id="interactiveBody" class="form-control" rows="3" maxlength="1024"></textarea></div>
      <div id="interactiveButtons"></div>
      <button class="btn btn-sm btn-outline-secondary mt-2" id="addBtnRow" type="button">+ Add button</button>
      <div class="small text-muted mt-2">1-3 buttons, each title max 20 chars.</div>
    </div>
    <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" id="sendInteractiveConfirm">Send interactive</button></div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  const activeMobile = '{{ active_mobile or "" }}';
  const apiUrl = '{{ url_for("whatsapp_messages_api") }}';
  const pageUrl = '{{ url_for("whatsapp_complaints") }}';
  const sendUrl = '{{ url_for("send_whatsapp") }}';
  const templateListUrl = '{{ url_for("whatsapp_templates_api") }}';
  const sendTemplateUrl = '{{ url_for("send_whatsapp_template_api") }}';
  const sendInteractiveUrl = '{{ url_for("send_whatsapp_interactive_api") }}';
  const staticBase = '{{ url_for("static", filename="") }}';

  const chatBody = document.getElementById('chatBody');
  const chatList = document.getElementById('chatList');
  const chatForm = document.getElementById('chatForm');
  const search = document.getElementById('chatSearch');
  const activeNameEl = document.getElementById('activeName');
  const activeMobileEl = document.getElementById('activeMobile');
  const templateBtn = document.getElementById('templateBtn');
  const interactiveBtn = document.getElementById('interactiveBtn');
  let lastMessageId = Number(chatBody?.dataset.lastMessageId || 0);
  let templates = [];

  const esc = (v) => String(v || '').replace(/[&<>'"]/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[m]));
  const fmt = (ts) => (ts && ts.includes(' ')) ? ts.split(' ')[1].slice(0,5) : '';
  const autoscroll = () => chatBody && (chatBody.scrollHeight - chatBody.scrollTop - chatBody.clientHeight < 120);
  const scrollBottom = () => { if (chatBody) chatBody.scrollTop = chatBody.scrollHeight; };

  const renderMessage = (m) => {
    const row = document.createElement('div');
    row.className = `msg-row ${m.direction === 'outbound' ? 'outbound' : 'incoming'}`;
    row.dataset.messageId = m.id;
    const media = m.media_url ? `${staticBase}${m.media_url}` : '';
    let html = '';
    if (m.message_type === 'image') html += media ? `<img class="msg-media" src="${media}" alt="image">` : '';
    if (m.message_type === 'video') html += media ? `<video class="msg-media" controls src="${media}"></video>` : '';
    if (m.message_type === 'audio') html += media ? `<audio controls src="${media}"></audio>` : '';
    if (m.message_type === 'document') html += media ? `<a target="_blank" class="btn btn-sm btn-light" href="${media}"><i class="fas fa-file"></i> ${esc(m.file_name || 'Document')}</a>` : '';
    const text = esc(m.text || (m.message_type === 'template' ? 'Template message' : m.message_type === 'interactive' ? 'Interactive message' : ''));
    html += `<p class="msg-text">${text}</p><div class="msg-time">${fmt(m.created_at)}</div>`;
    row.innerHTML = `<div class="msg-bubble">${html}</div>`;
    return row;
  };

  const renderContacts = (contacts) => {
    chatList.innerHTML = contacts.length ? contacts.map(c => `
      <a class="wa-item ${c.mobile === activeMobile ? 'active' : ''}" href="${pageUrl}?mobile=${encodeURIComponent(c.mobile)}" data-mobile="${esc(c.mobile)}" data-name="${esc((c.name || '').toLowerCase())}">
        <div class="wa-avatar">${esc((c.name || c.mobile || '?').slice(0,1).toUpperCase())}</div>
        <div class="wa-item-meta"><div class="wa-name">${esc(c.name || c.mobile)}</div><div class="wa-preview">${esc(c.preview || '')}</div></div>
        <div class="wa-time">${fmt(c.created_at)}</div>
      </a>`).join('') : '<div class="p-4 text-center text-muted">No chats yet.</div>';
  };

  async function poll() {
    const q = new URLSearchParams({ include_contacts: '1' });
    if (activeMobile) {
      q.set('mobile', activeMobile);
      q.set('since_id', String(lastMessageId || 0));
    }

    const res = await fetch(`${apiUrl}?${q.toString()}`, {headers: {'X-Requested-With':'XMLHttpRequest'}});
    if (!res.ok) return;
    const data = await res.json();

    if (data.contacts) {
      renderContacts(data.contacts);
      if (!activeMobile && data.contacts.length) {
        const firstMobile = data.contacts[0].mobile;
        if (firstMobile) {
          window.location.href = `${pageUrl}?mobile=${encodeURIComponent(firstMobile)}`;
          return;
        }
      }
    }

    if (data.active_name) activeNameEl.textContent = data.active_name;
    if (data.active_mobile) activeMobileEl.textContent = data.active_mobile;

    if (activeMobile && data.messages?.length) {
      const auto = autoscroll();
      data.messages.forEach((m) => {
        if (!chatBody.querySelector(`[data-message-id="${m.id}"]`)) chatBody.appendChild(renderMessage(m));
      });
      lastMessageId = data.last_message_id || lastMessageId;
      if (auto) scrollBottom();
    }
  }

  chatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(chatForm);
    const r = await fetch(sendUrl, {method:'POST', body:fd});
    if (!r.ok) { const p = await r.json(); alert(p.error || 'Failed to send message'); return; }
    chatForm.reset();
    await poll();
  });

  search?.addEventListener('input', () => {
    const q = search.value.trim().toLowerCase();
    chatList.querySelectorAll('.wa-item').forEach((item) => {
      const txt = `${item.dataset.name || ''} ${item.dataset.mobile || ''}`;
      item.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  const hasBootstrap = typeof window.bootstrap !== 'undefined' && window.bootstrap.Modal;
  const templateModal = hasBootstrap ? new window.bootstrap.Modal(document.getElementById('templateModal')) : null;
  const interactiveModal = hasBootstrap ? new window.bootstrap.Modal(document.getElementById('interactiveModal')) : null;
  if (!hasBootstrap) {
    console.warn('Bootstrap modal JS not available. Template/interactive dialogs are disabled, but inbox polling remains active.');
  }

  function getTemplateBodyVars(template) {
    const bodyComp = (template.components || []).find((c) => c.type === 'BODY');
    if (!bodyComp?.text) return [];
    const seen = new Set();
    const regex = new RegExp('\\\\{\\\\{\\s*([^}]+)\\s*\\\\}\\\\}', 'g');
    return [...bodyComp.text.matchAll(regex)].map((m) => m[1].trim()).filter((v) => (seen.has(v) ? false : (seen.add(v), true)));
  }

  async function loadTemplates() {
    if (templates.length) return;
    const res = await fetch(templateListUrl);
    if (!res.ok) return;
    const payload = await res.json();
    templates = (payload.data || []).filter((t) => (t.status || '').toUpperCase() === 'APPROVED');
    const select = document.getElementById('templateSelect');
    select.innerHTML = templates.map((t) => `<option value="${esc(t.name)}">${esc(t.name)} (${esc(t.language || 'en_US')})</option>`).join('') || '<option value="">No approved templates</option>';
    select.dispatchEvent(new Event('change'));
  }

  document.getElementById('templateSelect').addEventListener('change', (e) => {
    const t = templates.find((x) => x.name === e.target.value);
    const params = getTemplateBodyVars(t || {});
    const wrap = document.getElementById('templateParams');
    wrap.innerHTML = params.length ? params.map((p, i) => `<div class="col-md-6"><label class="form-label">Param ${i+1} (${esc(p)})</label><input class="form-control" data-param="${esc(p)}"></div>`).join('') : '<div class="text-muted small">No body parameters detected.</div>';
    document.getElementById('templateLanguage').value = t?.language || 'en_US';
  });

  templateBtn?.addEventListener('click', async () => {
    if (!templateModal) { alert('Template dialog unavailable right now. Please reload the page.'); return; }
    await loadTemplates();
    templateModal.show();
  });

  document.getElementById('sendTemplateConfirm').addEventListener('click', async () => {
    const tName = document.getElementById('templateSelect').value;
    if (!tName) return;
    const language = document.getElementById('templateLanguage').value || 'en_US';
    const inputs = [...document.querySelectorAll('#templateParams [data-param]')];
    const bodyParams = inputs.map((input) => ({type:'text', text: input.value || ''})).filter((p) => p.text.trim());
    const payload = {
      mobile: activeMobile,
      template_name: tName,
      language_code: language,
      components: bodyParams.length ? [{type:'body', parameters: bodyParams}] : []
    };
    const res = await fetch(sendTemplateUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Failed to send template'); return; }
    if (templateModal) templateModal.hide();
    await poll();
  });

  const buttonsWrap = document.getElementById('interactiveButtons');
  const addButtonRow = (title = '') => {
    if (buttonsWrap.querySelectorAll('.btn-row').length >= 3) return;
    const idx = buttonsWrap.querySelectorAll('.btn-row').length + 1;
    const row = document.createElement('div');
    row.className = 'input-group mb-2 btn-row';
    row.innerHTML = `<span class="input-group-text">${idx}</span><input class="form-control btn-title" maxlength="20" placeholder="Button title" value="${esc(title)}"><button class="btn btn-outline-danger" type="button">Ã—</button>`;
    row.querySelector('button').addEventListener('click', () => row.remove());
    buttonsWrap.appendChild(row);
  };
  document.getElementById('addBtnRow').addEventListener('click', () => addButtonRow());
  interactiveBtn?.addEventListener('click', () => {
    if (!interactiveModal) { alert('Interactive dialog unavailable right now. Please reload the page.'); return; }
    if (!buttonsWrap.children.length) { addButtonRow('Yes'); addButtonRow('No'); }
    interactiveModal.show();
  });

  document.getElementById('sendInteractiveConfirm').addEventListener('click', async () => {
    const body = document.getElementById('interactiveBody').value.trim();
    const header = document.getElementById('interactiveHeader').value.trim();
    const titles = [...document.querySelectorAll('.btn-title')].map((el) => el.value.trim()).filter(Boolean).slice(0,3);
    if (!body || titles.length < 1) { alert('Body and at least one button are required.'); return; }
    const payload = {
      mobile: activeMobile,
      header,
      body,
      buttons: titles.map((title, i) => ({id: `btn_${Date.now()}_${i+1}`, title}))
    };
    const res = await fetch(sendInteractiveUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Failed to send interactive message'); return; }
    if (interactiveModal) interactiveModal.hide();
    document.getElementById('interactiveBody').value = '';
    document.getElementById('interactiveHeader').value = '';
    buttonsWrap.innerHTML = '';
    await poll();
  });

  scrollBottom();
  poll().catch((error) => console.error('Initial WhatsApp poll failed', error));
  setInterval(() => poll().catch((error) => console.error('WhatsApp poll failed', error)), 5000);
})();
</script>
{% endblock %}
