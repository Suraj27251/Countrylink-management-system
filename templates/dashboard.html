{% extends 'layout.html' %}
{% block title %}Complaint Dashboard{% endblock %}
{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block header_actions %}
    <select>
        <option value="en">ENGLISH</option>
        <option value="hi">HINDI</option>
    </select>
    <div class="theme-toggle" style="margin-left:15px;">
        <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
        </label>
        <span class="theme-label"><i class="fas fa-moon"></i></span>
    </div>
    <a href="{{ url_for('auth.logout') }}"
       class="ml-3 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded flex items-center gap-2 text-sm">
       <i class="fas fa-right-from-bracket"></i> Logout
    </a>
{% endblock %}
{% block tabs %}
    <div class="sidebar-chart-container">
        <canvas id="sidebarChart"></canvas>
    </div>
    <div class="tab active"><a href="{{ url_for('dashboard') }}"><i class="fas fa-gauge"></i> Dashboard</a></div>
    <div class="tab"><a href="{{ url_for('complaints_page') }}"><i class="fas fa-code-branch"></i> Complaints</a></div>
    <div class="tab"><a href="{{ url_for('new_connections') }}"><i class="fas fa-user-plus"></i> New Connections</a></div>
    <div class="tab"><a href="{{ url_for('stock') }}"><i class="fas fa-boxes"></i> Stock</a></div>
    <div class="tab"><a href="{{ url_for('hr_dashboard') }}"><i class="fas fa-users"></i> Human Resource</a></div>
{% endblock %}
{% block content %}
    <div class="dashboard-wrapper">
        <section class="section-card">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Network Status</h2>
                    <p class="section-meta">Auto-refreshes every 5 seconds with live availability.</p>
                </div>
                <span class="status-pill"><i class="fas fa-signal"></i> Live</span>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-start sm:space-x-8">
                <div id="ip-status-list" class="grid grid-cols-1 sm:grid-cols-3 gap-4 flex-1">
                    <div data-ip="103.149.126.10" class="network-card">
                        <div class="network-card__info">
                            <i class="fas fa-server"></i>
                            <div>
                                <span class="network-card__name">Vishrantwadi</span>
                                <span class="network-card__meta">Core router</span>
                            </div>
                        </div>
                        <i class="status-icon fas fa-circle-notch fa-spin text-gray-400"></i>
                    </div>
                    <div data-ip="36.50.163.244" class="network-card">
                        <div class="network-card__info">
                            <i class="fas fa-server"></i>
                            <div>
                                <span class="network-card__name">Dhanori</span>
                                <span class="network-card__meta">Distribution hub</span>
                            </div>
                        </div>
                        <i class="status-icon fas fa-circle-notch fa-spin text-gray-400"></i>
                    </div>
                    <div data-ip="154.84.251.178" class="network-card">
                        <div class="network-card__info">
                            <i class="fas fa-server"></i>
                            <div>
                                <span class="network-card__name">Tingrenagar</span>
                                <span class="network-card__meta">Access gateway</span>
                            </div>
                        </div>
                        <i class="status-icon fas fa-circle-notch fa-spin text-gray-400"></i>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="stat-card bg-blue-500 text-white">
                <div class="stat-text">
                    <div class="label">Total Complaints</div>
                    <div class="value">{{ total }}</div>
                    <div class="stat-subtext">All sources combined</div>
                </div>
                <div class="stat-icon"><i class="fas fa-inbox"></i></div>
            </div>
            <div class="stat-card bg-yellow-500 text-white">
                <div class="stat-text">
                    <div class="label">Pending</div>
                    <div class="value">{{ pending }}</div>
                    <div class="stat-subtext">Needs attention</div>
                </div>
                <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
            </div>
            <div class="stat-card bg-green-500 text-white">
                <div class="stat-text">
                    <div class="label">Resolved</div>
                    <div class="value">{{ resolved }}</div>
                    <div class="stat-subtext">Completed updates</div>
                </div>
                <div class="stat-icon"><i class="fas fa-circle-check"></i></div>
            </div>
        </section>

        <section class="section-card">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Status Breakdown</h2>
                    <p class="section-meta">Monitor resolution performance at a glance.</p>
                </div>
            </div>
            <div class="chart-container" style="height:300px;">
                <canvas id="statusChart"></canvas>
            </div>
        </section>

        <div class="table-section centered-card recent-complaints-card w-full">
            <div class="recent-complaints-header">
                <div>
                    <h2 class="section-title">Recent Complaints</h2>
                    <p class="section-meta">Filter quickly to triage incoming issues.</p>
                </div>
                <div class="category-filters">
                    <button type="button" class="button filter-btn" data-category="All">All</button>
                    {% for cat in categories %}
                    <button type="button" class="button filter-btn" data-category="{{ cat }}">{{ cat }}</button>
                    {% endfor %}
                </div>
            </div>
        <form id="bulkActionForm" method="POST" class="w-full">
            <div class="bulk-buttons recent-complaints-actions">
                <button type="submit"
                        class="button bulk animated-button btn-resolve pulse-on-hover"
                        formaction="{{ url_for('update_complaints_bulk') }}"
                        name="action" value="resolve">
                    Mark Resolved
                </button>
                <button type="submit"
                        class="button bulk danger animated-button btn-delete pulse-on-hover"
                        formaction="{{ url_for('update_complaints_bulk') }}"
                        name="action" value="delete"
                        onclick="return confirm('Are you sure to delete selected complaints?')">
                    Delete
                </button>
            </div>
            <div class="table-responsive w-full">
                <table class="data-table recent-complaints-table">
                    <colgroup>
                        <col style="width:40px;">
                        <col style="width:50px;">
                        <col style="width:120px;">
                        <col style="width:130px;">
                        <col style="width:260px;">
                        <col style="width:120px;">
                        <col style="width:110px;">
                        <col style="width:80px;">
                        <col style="width:100px;">
                        <col style="width:110px;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Complaint</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Source</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in recent_complaints %}
                        {% set src = comp['source'] %}
                        {% if src != 'Webhook' %}
                        <tr data-category="{{ comp['category'] }}">
                            <td><input type="checkbox" name="selected_ids[]" value="{{ comp['id'] }}"></td>
                            <td>{{ comp['id'] }}</td>
                            <td>{{ comp['name'] }}</td>
                            <td>{{ comp['mobile'] }}</td>
                            <td class="td-complaint" title="{{ comp['complaint'] }}">{{ comp['complaint'] }}</td>
                            <td>
                                <span class="badge category-{{ comp['category']|lower|replace(' ', '-') }}">{{ comp['category'] }}</span>
                            </td>
                            <td>{{ comp['status'] }}</td>
                            <td>{{ comp['priority'] }}</td>
                            <td>
                                <span class="badge source-badge web">
                                    <i class="fas fa-globe"></i> <span>{{ src or 'Web' }}</span>
                                </span>
                            </td>
                            <td>
                                {% if comp['status'] != 'Resolved' %}
                                <a class="btn small animated-button btn-resolve pulse-on-hover"
                                   href="{{ url_for('update_status', complaint_id=comp['id'], status='Resolved') }}">
                                   Mark Resolved
                                </a>
                                {% else %}
                                <span style="color: green;">âœ” Done</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
        </div>

        {% if pending_connections %}
        <section class="section-card table-card">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Recent Connection Requests</h2>
                    <p class="section-meta">Pending requests waiting for approval.</p>
                </div>
                <a href="{{ url_for('new_connections') }}" class="button outline-button">View all</a>
            </div>
            <div class="table-responsive">
                <table class="data-table compact-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Area</th>
                            <th>Status</th>
                            <th>Requested At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for conn in pending_connections %}
                        <tr>
                            <td>{{ conn[0] }}</td>
                            <td>{{ conn[1] }}</td>
                            <td>{{ conn[2] }}</td>
                            <td>{{ conn[3] }}</td>
                            <td><span class="status-badge pending">{{ conn[4] }}</span></td>
                            <td>{{ conn[5] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}

        <section class="section-card table-card">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Current Stock Summary</h2>
                    <p class="section-meta">Quick snapshot of available inventory.</p>
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table compact-table">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Total Stock</th>
                            <th>Issued</th>
                            <th>Available</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device, summary in stock_summary.items() %}
                        <tr>
                            <td>{{ device }}</td>
                            <td>{{ summary.stock }}</td>
                            <td>{{ summary.issued }}</td>
                            <td>{{ summary.available }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
{% endblock %}
{% block extra_scripts %}
<script>
    const ctx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Pending', 'Resolved'],
            datasets: [{
                label: 'Complaint Status',
                data: [{{ pending }}, {{ resolved }}],
                backgroundColor: ['#FF6384', '#36A2EB'],
                borderColor: ['#fff', '#fff'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    const sidebarCtx = document.getElementById('sidebarChart');
    if (sidebarCtx) {
        new Chart(sidebarCtx, {
            type: 'bar',
            data: {
                labels: ['Pending', 'Resolved'],
                datasets: [{
                    data: [{{ pending }}, {{ resolved }}],
                    backgroundColor: ['#FF6384', '#36A2EB']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    const toggle = document.getElementById('themeToggle');
    const body = document.body;
    const theme = localStorage.getItem('theme');
    if (theme === 'dark') {
        body.classList.add('dark-mode');
        toggle.checked = true;
    }
    toggle.addEventListener('change', () => {
        body.classList.toggle('dark-mode');
        localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
    });
    document.getElementById('selectAll').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('input[name="selected_ids[]"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    const filterButtons = document.querySelectorAll('.filter-btn');
    if (filterButtons.length) {
        filterButtons[0].classList.add('active');
        filterButtons[0].setAttribute('aria-pressed', 'true');
    }
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const category = btn.getAttribute('data-category');
            filterButtons.forEach(button => {
                button.classList.remove('active');
                button.setAttribute('aria-pressed', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
            document.querySelectorAll('.recent-complaints-table tbody tr').forEach(row => {
                const rowCat = row.getAttribute('data-category');
                if (category === 'All' || rowCat === category) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    async function updateIpStatus() {
        try {
            const res = await fetch('{{ url_for('ping_status') }}');
            const data = await res.json();
            Object.entries(data).forEach(([ip, isUp]) => {
                const icon = document.querySelector(`#ip-status-list [data-ip="${ip}"] .status-icon`);
                if (!icon) return;
                if (isUp) {
                    icon.className = 'status-icon fas fa-check-circle text-green-500';
                } else {
                    icon.className = 'status-icon fas fa-times-circle text-red-500';
                }
            });
        } catch (err) {
            console.error('Failed to update IP status', err);
        }
    }
    updateIpStatus();
    setInterval(updateIpStatus, 5000);
</script>
{% endblock %}
