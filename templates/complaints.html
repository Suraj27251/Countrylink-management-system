{% extends 'layout.html' %}
{% block title %}All Complaints{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }
    .table thead {
      background-color: #007bff;
      color: white;
    }
    .table tbody tr:hover {
      background-color: #f1f1f1;
    }
    .badge-status {
      font-size: 0.85rem;
    }
    .status-Pending {
      background-color: #ffc107;
    }
    .status-Resolved {
      background-color: #28a745;
      color: white;
    }
    .filter-section {
      margin-bottom: 20px;
    }
    .search-input {
      max-width: 250px;
    }
    .action-btn {
      font-size: 16px;
      margin-right: 8px;
      cursor: pointer;
    }
    .delete-btn {
      color: red;
    }
    .resolve-btn {
      color: green;
    }
    .risk-badge {
      font-size: 0.75rem;
      padding: 0.35rem 0.6rem;
    }
    .risk-Highly\ Disturbed {
      background-color: #dc3545;
      color: #fff;
    }
    .risk-At\ Risk {
      background-color: #fd7e14;
      color: #fff;
    }
    .risk-Normal {
      background-color: #198754;
      color: #fff;
    }
    .trend-Rising {
      color: #dc3545;
      font-weight: 600;
    }
    .trend-Stable {
      color: #6c757d;
      font-weight: 600;
    }
    .trend-Falling {
      color: #198754;
      font-weight: 600;
    }
    .analysis-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
    }
  </style>
{% endblock %}
{% block tabs %}
  <div class="tab"><a href="{{ url_for('dashboard') }}"><i class="fas fa-gauge"></i> Dashboard</a></div>
  <div class="tab active"><a href="{{ url_for('complaints_page') }}"><i class="fas fa-code-branch"></i> Complaints</a></div>
  <div class="tab"><a href="{{ url_for('new_connections') }}"><i class="fas fa-user-plus"></i> New Connections</a></div>
  <div class="tab"><a href="{{ url_for('stock') }}"><i class="fas fa-boxes"></i> Stock</a></div>
  <div class="tab"><a href="{{ url_for('hr_dashboard') }}"><i class="fas fa-users"></i> Human Resource</a></div>
{% endblock %}
{% block content %}
<div class="container">
  <h2 class="mb-4 text-center">All Complaints Overview</h2>

  <div class="analysis-card mb-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h5 class="mb-1">Predictive Analysis (30-day window)</h5>
        <p class="text-muted mb-0">Highlights customers with rising complaint frequency and unresolved tickets.</p>
      </div>
      <div class="d-flex gap-3">
        <div class="text-center">
          <div class="fw-bold text-danger fs-4">{{ high_risk_total }}</div>
          <div class="text-muted">Highly Disturbed</div>
        </div>
        <div class="text-center">
          <div class="fw-bold text-warning fs-4">{{ at_risk_total }}</div>
          <div class="text-muted">At Risk</div>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <h6 class="mb-3">Top Disturbed Customers</h6>
      {% if high_risk_customers %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Mobile</th>
                <th>Risk Level</th>
                <th>Trend</th>
                <th>Complaints (30d)</th>
                <th>Unresolved (30d)</th>
                <th>Last Seen</th>
              </tr>
            </thead>
            <tbody>
              {% for customer in high_risk_customers %}
              <tr>
                <td>{{ customer.mobile }}</td>
                <td><span class="badge risk-badge risk-{{ customer.risk_level }}">{{ customer.risk_level }}</span></td>
                <td class="trend-{{ customer.trend }}">{{ customer.trend }}</td>
                <td>{{ customer.count_30d }}</td>
                <td>{{ customer.unresolved_30d }}</td>
                <td>{{ customer.last_seen }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted">No high-risk customers detected yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="filter-section d-flex justify-content-between align-items-center">
    <div>
      <label for="statusFilter" class="form-label">Filter by Status:</label>
      <select id="statusFilter" class="form-select d-inline-block w-auto">
        <option value="">All</option>
        <option value="Pending">Pending</option>
        <option value="Resolved">Resolved</option>
      </select>
    </div>
    <input type="text" id="searchInput" class="form-control search-input" placeholder="Search by name or mobile">
    <button class="btn btn-success" onclick="downloadCSV()">Download CSV</button>
  </div>

  <!-- Bulk Action -->
  <div class="mb-3 d-flex gap-2">
    <select id="bulkAction" class="form-select w-auto">
      <option value="">Bulk Action</option>
      <option value="resolve">Mark as Resolved</option>
      <option value="delete">Delete</option>
    </select>
    <button class="btn btn-primary" onclick="applyBulkAction()">Apply</button>
  </div>

  {% if complaints %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle" id="complaintsTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>ID</th>
          <th>Name</th>
          <th>Mobile</th>
          <th>Complaint</th>
          <th>Status</th>
          <th>Risk</th>
          <th>Trend</th>
          <th>Received At</th>
          <th>Source</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in complaints %}
        <tr id="row-{{ c.id }}">
          <td><input type="checkbox" class="selectComplaint" value="{{ c.id }}"></td>
          <td>{{ c.id }}</td>
          <td>
            {% set source = c.source or 'Web' %}
            {{ c.name }}
          </td>
          <td>{{ c.mobile }}</td>
          <td>{{ c.complaint }}</td>
          <td><span class="badge badge-status status-{{ c.status }}" id="status-{{ c.id }}">{{ c.status }}</span></td>
          <td><span class="badge risk-badge risk-{{ c.risk_level }}">{{ c.risk_level }}</span></td>
          <td class="trend-{{ c.trend }}">{{ c.trend }}</td>
          <td>{{ c.created_at }}</td>
          <td>{{ source }}</td>
          <td>
            <span class="action-btn resolve-btn" title="Mark as Resolved" onclick="markResolved({{ c.id }})">‚úîÔ∏è</span>
            <span class="action-btn delete-btn" title="Delete Complaint" onclick="deleteComplaint({{ c.id }})">üóëÔ∏è</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-info text-center">No complaints found.</div>
  {% endif %}
</div>

<script>
  document.getElementById('statusFilter').addEventListener('change', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#complaintsTable tbody tr');
    rows.forEach(row => {
      const status = row.children[5].textContent.toLowerCase();
      row.style.display = (filter === '' || status === filter) ? '' : 'none';
    });
  });

  document.getElementById('searchInput').addEventListener('keyup', function () {
    const search = this.value.toLowerCase();
    const rows = document.querySelectorAll('#complaintsTable tbody tr');
    rows.forEach(row => {
      const name = row.children[2].textContent.toLowerCase();
      const mobile = row.children[3].textContent.toLowerCase();
      row.style.display = (name.includes(search) || mobile.includes(search)) ? '' : 'none';
    });
  });

  document.getElementById('selectAll').addEventListener('change', function () {
    document.querySelectorAll('.selectComplaint').forEach(cb => cb.checked = this.checked);
  });

  function downloadCSV() {
    const rows = document.querySelectorAll("#complaintsTable tr");
    let csv = [];
    rows.forEach(row => {
      const cols = row.querySelectorAll("td, th");
      const rowData = Array.from(cols).map(col => `"${col.textContent.trim()}"`).join(",");
      csv.push(rowData);
    });
    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "complaints.csv";
    a.click();
  }

  function deleteComplaint(id) {
    if (!confirm("Are you sure you want to delete this complaint?")) return;

    fetch(`/delete_complaint/${id}`, { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') document.getElementById(`row-${id}`).remove();
        else alert('Failed to delete complaint.');
      }).catch(() => alert('Error deleting complaint.'));
  }

  function markResolved(id) {
    if (!confirm("Mark this complaint as resolved?")) return;

    fetch(`/update_status/${id}/Resolved`).then(response => {
      if (response.redirected) {
        const badge = document.getElementById(`status-${id}`);
        badge.textContent = 'Resolved';
        badge.classList.remove('status-Pending');
        badge.classList.add('status-Resolved');
      }
    }).catch(() => alert('Error updating status.'));
  }

  function applyBulkAction() {
    const action = document.getElementById('bulkAction').value;
    const selected = Array.from(document.querySelectorAll('.selectComplaint:checked')).map(cb => cb.value);

    if (!action || selected.length === 0) {
      alert('Please select action and at least one complaint.');
      return;
    }

    fetch('/update_complaints_bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: action,
        'selected_ids[]': selected
      })
    })
    .then(() => location.reload())
    .catch(err => alert('Error: ' + err));
  }
</script>
{% endblock %}
